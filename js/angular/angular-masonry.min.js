(function(){"use strict";angular.module("masonryLayout",[]).directive("masonry",["$window","$rootScope",function(e,t){function n(t,n,r){this.IMG_MARGIN_X=t;this.IMG_MARGIN_Y=n;this.IMG_WIDTH=r;this.imagesLoadCount=0;this.totalItemCount=0;this.resizing=false;this.windowWidth=e.innerWidth;this.containers;this.containerWidth;this.marginWidth}n.prototype={constructor:n,docHeight:function(){return e.innerHeight*2.5},reset:function(e){var t;document.body.style.overflow="scroll";this.containerWidth=e[0].clientWidth;document.body.style.overflow="auto";t=Math.floor((this.containerWidth+this.IMG_MARGIN_X)/(this.IMG_WIDTH+this.IMG_MARGIN_X));this.marginWidth=Math.abs((this.containerWidth-this.IMG_WIDTH*t-this.IMG_MARGIN_X*(t-1))/2);this.containers=new Array(t);for(var n=0,r=this.containers.length;n<r;n++){this.containers[n]=0}},setWindowWidth:function(){this.windowWidth=e.innerWidth},shortest:function(){return this.containers.indexOf(this.containers.slice().sort(function(e,t){return e-t})[0])},shouldResize:function(){return Math.abs(this.windowWidth-e.innerWidth)>25&&!this.resizing?true:false},tallest:function(){return this.containers.slice().sort(function(e,t){return t-e})[0]},update:function(e,t){this.containers[e]+=t}};return{restrict:"A",link:function(t,r,i,s){var o=new n(+i.xMargin,+i.yMargin,+i.imgWidth),u,a,f,l,c;var h=function(){f=o.shortest();l=f*(o.IMG_WIDTH+o.IMG_MARGIN_X)+o.marginWidth;c=o.containers[f]};var p=function(){if(o.shouldResize()){o.resizing=true;o.setWindowWidth();o.reset(r);u=r[0].children;for(var e=0,t=u.length;e<t;e++){a=u[e];h();a.style.cssText+="; left: "+l+"px; top: "+c+"px;";o.update(f,a.scrollHeight+o.IMG_MARGIN_Y)}r[0].style.height=o.tallest()+"px";o.resizing=false}};var d=function(e){h();e.style.cssText+="; left: "+l+"px; top: "+c+"px;";o.update(f,e.scrollHeight+o.IMG_MARGIN_Y);if(++o.imagesLoadCount===o.totalItemCount){r[0].style.height=o.tallest()+"px"}};var v=function(e){var t=e.getElementsByTagName("img")[0];e.style.cssText+="; left: -999px; top: -999px; position:absolute; ";t.addEventListener("load",function(){d(e)});t.addEventListener("error",function(){o.imagesLoadCount++})};t.$watch(function(){return r[0].children.length},function(e,t){if(e===t)return;if(t===0){r[0].style.height=0;o.totalItemCount=0;o.imagesLoadCount=0;o.reset(r)}o.totalItemCount=e;r[0].style.height=o.tallest()+o.docHeight()+"px";for(var n=t;n<e;n++){v(r[0].children[n])}});angular.element(e).on("resize",p);t.$on("$destroy",function(){angular.element(e).off("resize",p)});r[0].style.position="relative"}}}])})()